pipeline {
    agent any

    environment {
        IMAGE_NAME = 'shieldxbot/backend_exemple_new'  // Thay đổi tên image nếu cần
        // Lưu ý: TELEGRAM_TOKEN và TELEGRAM_CHAT_ID -> credential kiểu "Secret text"
        TELEGRAM_TOKEN = credentials('telegram-bot-token')
        TELEGRAM_CHAT_ID = credentials('telegram-chat-id')
    }

    stages {

        stage('Prepare') {
            steps {
                script {
                    def branch = env.BRANCH_NAME ?: env.GIT_BRANCH ?: 'main'
                    branch = branch.replaceAll('origin/', '')
                    env.IMAGE_TAG = "v${BUILD_NUMBER}-${branch}"
                    echo "Using IMAGE_TAG=${env.IMAGE_TAG}"
                }
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                // Dùng withCredentials để chắc chắn biến tồn tại tại chỗ cần dùng
                withCredentials([usernamePassword(credentialsId: 'docker-hub-login', usernameVariable: 'DOCKER_HUB_USR', passwordVariable: 'DOCKER_HUB_PSW')]) {
                    
                     sh '''
                      
                       rm -rf Learn_Jenkins
                         ls -la
                       git clone  https://github.com/shieldx-bot/Learn_Jenkins.git
                    
                       cd Learn_Jenkins 
                        set -e
                        echo "Building image ${IMAGE_NAME}:${IMAGE_TAG}"

                        # đảm bảo path đúng
                        ls -la ./step2/backend2 || (echo "ERROR: build context ./step2/backend2 not found" && exit 1)

                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ./step2/backend2

                        # login an toàn: password qua stdin
                        echo "${DOCKER_HUB_PSW}" | docker login -u "${DOCKER_HUB_USR}" --password-stdin

                        docker push ${IMAGE_NAME}:${IMAGE_TAG}
                        
                     
                    '''
                }
            }
        }

        stage('Update GitOps Manifest') {
            steps {
                script {
                    // Debug: kiểm tra branch hiện tại
                    echo "BRANCH_NAME: ${env.BRANCH_NAME}"
                    echo "GIT_BRANCH: ${env.GIT_BRANCH}"
                    echo "Current branch detection: ${env.BRANCH_NAME ?: env.GIT_BRANCH ?: 'unknown'}"
                }
                
                withCredentials([usernamePassword(credentialsId: 'git_credentials', usernameVariable: 'GIT_USR', passwordVariable: 'GIT_PSW')]) {
                    sh '''
                        set -e

                        # xóa thư mục cũ nếu tồn tại
                        rm -rf my-gitops-config
                        ls -la

                        # tạo ~/.netrc để git clone/push không hỏi mật khẩu
                        cat > ~/.netrc <<EOF
machine github.com
login ${GIT_USR}
password ${GIT_PSW}
EOF
                        chmod 600 ~/.netrc

                        # cấu hình git
                        git config --global user.email "jenkins-bot@shieldx.local"
                        git config --global user.name "jenkins-bot"

                        # clone repo gitops
                        git clone https://github.com/shieldx-bot/my-gitops-config.git
                        cd my-gitops-config/k8s

                        # cập nhật image tag trong manifest
                        sed -i "s|image: shieldxbot/backend_exemple_new:.*|image: shieldxbot/backend_exemple_new:${IMAGE_TAG}|g" Deployment.yaml
                        cat Deployment.yaml

                        # commit và push
                        git add Deployment.yaml
                        git commit -m "GitOps: update backend image to ${IMAGE_TAG}" || echo "No changes to commit"
                        git push origin main

                        # dọn dẹp
                        cd ../..
                        rm -f ~/.netrc
                        
                        echo "✅ GitOps manifest updated successfully!"
                    '''
                }
            }
        }
    }

    post {
        success {
            script { NotifyTelegram("SUCCEEDED") }
        }
        failure {
            script { NotifyTelegram("FAILED") }
        }
    }
}

def NotifyTelegram(String status) {
    def msg = "Jenkins ${status}\\nJob: ${JOB_NAME}\\nBuild: #${BUILD_NUMBER}\\n${BUILD_URL}"
    sh """
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${msg}"
    """
}
