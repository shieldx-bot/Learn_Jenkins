pipeline {
    agent any
    environment{
        // Nếu 'docker-hub-login' là username/password credential, Jenkins sẽ tạo:
        // DOCKER_HUB_USR và DOCKER_HUB_PSW
        DOCKER_HUB = credentials('docker-hub-login')
        // Nếu telegram token/chat id là secret text, thì biến sẽ chứa giá trị trực tiếp
        TELEGRAM_TOKEN = credentials('telegram-bot-token')
        TELEGRAM_CHAT_ID = credentials('telegram-chat-id')
        image_name = 'shieldxbot/backend_exemple'
        image_tag = "v${BUILD_NUMBER}-${BRANCH_NAME}"
        git-credentials = credentials('git-credentials')
    }
    stages{

        
       stage("Update Manifest (GitOps)") {
            when {
                branch 'main'
            }
            steps {
                script {
                     env.IMAGE_TAG = "v${env.BUILD_NUMBER}-${env.BRANCH_NAME ?: 'main'}"
                }
                withCredentials([usernamePassword(credentialsId: 'git-credentials', passwordVariable: 'GIT_PSW', usernameVariable: 'GIT_USR')]) {
                    dir('app1') { 
                        sh ' git config --global user.email "jenkins-bot@shieldx.local" '
                        sh ' git config --global user.name "jenkins-bot" '
                        sh ' git clone https://$GIT_USR:$GIT_PSW@github.com/shieldx-bot/Learn_Jenkins.git'
                        dir('Learn_Jenkins') {
                            sh '''
                                cd k8s-manifests
                                sed -i "s|image: shieldxbot/backend_exemple:.*|image: shieldxbot/backend_exemple:${IMAGE_TAG}|g" ./k8s/deployment.yaml
                                git add ./k8s/deployment.yaml
                                git commit -m "Update backend image to ${IMAGE_TAG}"
                                git push origin main
                            '''
                            sh """
                            docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ./step2/backend2
                            docker login -u ${DOCKER_HUB_USR} -p ${DOCKER_HUB_PSW}
                            docker push ${IMAGE_NAME}:${IMAGE_TAG}
                            """
                    }
                }
  
            }
        }

        stage('Update GitOps Mainfest'){ 
            steps {
                script {
                    env.IMAGE_TAG = "v${env.BUILD_NUMBER}-${env.BRANCH_NAME ?: 'main'}"
                }
                withCredentials([usernamePassword(credentialsId: 'git-credentials', passwordVariable: 'GIT_PSW', usernameVariable: 'GIT_USR')]) {
                    dir('app2') { 
                        sh ' git config --global user.email "jenkins-bot@shieldx.local" '
                        sh ' git config --global user.name "jenkins-bot" '
                        sh ' git clone https://$GIT_USR:$GIT_PSW@github.com/shieldx-bot/my-gitops-config.git'
                        dir('my-gitops-config') {
                            sh '''
                                cd k8s
                                sed -i "s|image: shieldxbot/backend_exemple:.*|image: shieldxbot/backend_exemple:${IMAGE_TAG}|g" ./backend-deployment.yaml
                                git add ./backend-deployment.yaml
                                git commit -m "Update backend image to ${IMAGE_TAG}"
                                git push origin main
                            '''
                        }

                    }
                }
            }
        } 
        }


        
    } 
    post {
        success {
            NotifyTelegram("SUCCEEDED")
        }
        failure {
            NotifyTelegram("FAILED")
        }
    }
}


def NotifyTelegram(String status) {
    def msg = "Jenkins Pipeline ${status} for ${JOB_NAME} - Build #${BUILD_NUMBER} \nCheck details at: ${BUILD_URL}"
    sh '''curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" --data-urlencode "text=''' + msg + '''" '''
}